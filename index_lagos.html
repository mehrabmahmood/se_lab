<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CropWise — Lagos Weather → Disease Risk</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen bg-slate-100 text-slate-800">
  <div class="mx-auto max-w-6xl p-4 sm:p-6">
    <!-- TOP WEATHER BAR -->
    <section class="relative overflow-hidden rounded-2xl bg-gradient-to-r from-emerald-950 via-emerald-900 to-emerald-800 p-5 text-white shadow-lg">
      <div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">

        <!-- Left: city + weather -->
        <div class="flex items-center gap-4">
          <div class="grid h-14 w-14 place-items-center rounded-full bg-emerald-900/50 ring-1 ring-white/10">
            <svg viewBox="0 0 64 64" class="h-10 w-10" fill="none" aria-hidden="true">
              <circle cx="32" cy="32" r="14" fill="#FBBF24" />
              <g stroke="#FCD34D" stroke-width="4" stroke-linecap="round">
                <path d="M32 6v8" /><path d="M32 50v8" /><path d="M6 32h8" /><path d="M50 32h8" />
                <path d="M13 13l6 6" /><path d="M45 45l6 6" /><path d="M51 13l-6 6" /><path d="M19 45l-6 6" />
              </g>
            </svg>
          </div>

          <div class="leading-tight">
            <div class="flex items-center gap-3">
              <div id="wxCity" class="text-lg font-semibold opacity-95">Lagos, Nigeria</div>
              <span class="rounded-md bg-white/10 px-2 py-0.5 text-xs font-semibold ring-1 ring-white/10">Fixed City</span>
            </div>

            <div class="flex items-end gap-2">
              <div id="wxTemp" class="text-5xl font-bold tracking-tight">--</div>
              <div class="pb-1 text-2xl font-semibold opacity-90">°C</div>
            </div>

            <div class="mt-1 flex flex-wrap items-center gap-x-3 gap-y-1 text-sm text-white/80">
              <span id="wxWhen">--</span>
              <span class="hidden sm:inline">|</span>
              <span id="wxDesc">--</span>
              <span class="hidden sm:inline">|</span>
              <span>Humidity: <span id="wxHumidity">--</span>%</span>
              <span class="hidden sm:inline">|</span>
              <span>Wind: <span id="wxWind">--</span> km/h</span>
              <span class="hidden sm:inline">|</span>
              <span>Rain: <span id="wxRain">--</span> mm</span>
            </div>

            <div id="wxNote" class="mt-1 text-xs text-white/60"></div>
          </div>
        </div>

        <!-- Right: controls -->
        <div class="w-full lg:max-w-[520px]">
          <div class="flex items-center gap-3">
            <div class="text-sm font-semibold">Live weather → model → cards</div>
            <button
              id="wxRefresh"
              class="ml-auto rounded-lg bg-white/10 px-3 py-2 text-xs font-semibold text-white/90 ring-1 ring-white/10 hover:bg-white/15"
              type="button"
            >
              Refresh
            </button>
          </div>

          <div class="mt-4 rounded-xl bg-white/5 p-4 ring-1 ring-white/10">
            <div class="text-xs text-white/70">
              Backend: <code>POST http://127.0.0.1:8000/predict</code>
            </div>
            <div class="mt-2 text-xs text-white/60" id="apiStatus">Status: waiting…</div>
          </div>
        </div>

      </div>
    </section>

    <!-- MAIN GRID -->
    <main class="mt-6 grid grid-cols-1 gap-6 lg:grid-cols-2">

      <!-- LEFT: DISEASE CARDS -->
      <section class="rounded-2xl bg-white p-5 shadow-lg ring-1 ring-slate-200">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-semibold text-emerald-900">Probable Disease Risk (Lagos)</h2>
        </div>

        <!-- Big image block -->
        <div class="mt-4 overflow-hidden rounded-2xl ring-1 ring-slate-200">
          <div class="relative h-40 bg-gradient-to-r from-emerald-900 via-emerald-800 to-emerald-700">
            <div class="absolute inset-0 bg-emerald-950/25"></div>

            <div class="absolute left-4 top-4 flex items-start gap-4 rounded-xl bg-emerald-950/85 px-4 py-3 text-white shadow-xl ring-1 ring-white/10">
              <div>
                <div class="text-lg font-semibold">
                  <span id="risk1Name">Late Blight</span>
                  <span class="ml-2 inline-block h-0.5 w-14 rounded bg-amber-300 align-middle"></span>
                </div>
                <div id="risk1Note" class="mt-1 text-sm text-white/75">Wet conditions & cool temps.</div>
              </div>

              <div id="risk1Score" class="ml-2 grid h-10 w-16 place-items-center rounded-lg bg-rose-600 text-sm font-bold shadow">
                82%
              </div>
            </div>
          </div>
        </div>

        <div class="mt-4 grid grid-cols-1 gap-3 sm:grid-cols-3">
          <div class="rounded-xl bg-emerald-950 p-4 text-white shadow-sm ring-1 ring-emerald-900/40">
            <div class="font-semibold leading-tight">
              <span id="risk2Name">Powdery Mildew</span>
              <span id="risk2Score" class="ml-2 inline-flex rounded-md bg-amber-300/90 px-2 py-0.5 text-sm font-bold text-emerald-950">56%</span>
            </div>
            <div id="risk2Note" class="mt-2 text-sm text-white/75">Humid weather</div>
          </div>

          <div class="rounded-xl bg-white p-4 shadow-sm ring-1 ring-slate-200">
            <div class="font-semibold leading-tight text-emerald-900">
              <span id="risk3Name">Leaf Spot</span>
              <span id="risk3Score" class="ml-2 inline-flex rounded-md bg-emerald-600 px-2 py-0.5 text-sm font-bold text-white">30%</span>
            </div>
            <div id="risk3Note" class="mt-2 text-sm text-slate-500">Recent dry period</div>
          </div>

          <div class="rounded-xl bg-white p-4 shadow-sm ring-1 ring-slate-200">
            <div class="text-xs font-semibold text-slate-500">City</div>
            <div class="mt-2 text-sm font-semibold text-slate-800">Lagos, Nigeria</div>
            <div class="mt-1 text-xs text-slate-500">Lat: 6.5244, Lon: 3.3792</div>
          </div>
        </div>
      </section>

      <!-- RIGHT: EXPLANATION -->
      <section class="rounded-2xl bg-white p-5 shadow-lg ring-1 ring-slate-200">
        <h2 class="text-xl font-semibold text-emerald-900">Explanation & Actions</h2>
        <p class="mt-4 text-sm text-slate-600">
          This is where you’ll plug your LLM explanation later.
        </p>

        <div class="mt-6 rounded-xl bg-slate-900 p-4 text-white">
          <div class="text-sm font-semibold text-white/90">Inputs sent to model</div>
          <div class="mt-3 grid grid-cols-2 gap-3 text-sm">
            <div class="rounded-lg bg-white/10 p-3">
              <div class="text-white/70">Day</div>
              <div class="mt-1 font-bold" id="wxDay">--</div>
            </div>
            <div class="rounded-lg bg-white/10 p-3">
              <div class="text-white/70">Sky</div>
              <div class="mt-1 font-bold" id="wxCond">--</div>
            </div>
          </div>
        </div>
      </section>

    </main>
  </div>

  <script>
    // ---- FIXED CITY: Lagos, Nigeria ----
    const CITY = "Lagos, Nigeria";
    const LAT = 6.5244;
    const LON = 3.3792;

    // Your FastAPI endpoint:
    const MODEL_API = "http://127.0.0.1:8000/predict";

    const el = {
      city: document.getElementById("wxCity"),
      temp: document.getElementById("wxTemp"),
      when: document.getElementById("wxWhen"),
      desc: document.getElementById("wxDesc"),
      humidity: document.getElementById("wxHumidity"),
      wind: document.getElementById("wxWind"),
      rain: document.getElementById("wxRain"),
      note: document.getElementById("wxNote"),
      refresh: document.getElementById("wxRefresh"),
      apiStatus: document.getElementById("apiStatus"),
      day: document.getElementById("wxDay"),
      cond: document.getElementById("wxCond"),
    };

    function dayShortFromDate(d) {
      const map = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
      return map[d.getDay()];
    }

    function weatherCodeToText(code) {
      const map = [
        { codes: [0], text: "Clear" },
        { codes: [1, 2], text: "Partly cloudy" },
        { codes: [3], text: "Overcast" },
        { codes: [45, 48], text: "Fog" },
        { codes: [51, 53, 55, 56, 57], text: "Drizzle" },
        { codes: [61, 63, 65, 66, 67], text: "Rain" },
        { codes: [71, 73, 75, 77], text: "Snow" },
        { codes: [80, 81, 82], text: "Showers" },
        { codes: [95, 96, 99], text: "Thunderstorm" },
      ];
      for (const m of map) if (m.codes.includes(code)) return m.text;
      return "Weather";
    }

    function formatWhen(dateObj) {
      const day = dateObj.toLocaleDateString(undefined, { weekday: "long" });
      const time = dateObj.toLocaleTimeString(undefined, { hour: "numeric", minute: "2-digit" });
      return `${day} · ${time}`;
    }

    function setCard(n, disease, confPct, comment) {
      const setText = (id, v) => { const e = document.getElementById(id); if (e) e.textContent = v; };
      setText(`risk${n}Name`, disease);
      setText(`risk${n}Score`, `${confPct}%`);
      setText(`risk${n}Note`, comment);
    }

    async function fetchWeather() {
      const url =
        "https://api.open-meteo.com/v1/forecast" +
        `?latitude=${encodeURIComponent(LAT)}` +
        `&longitude=${encodeURIComponent(LON)}` +
        "&current=temperature_2m,relative_humidity_2m,precipitation,wind_speed_10m,weather_code" +
        "&timezone=auto";

      const res = await fetch(url);
      if (!res.ok) throw new Error(`Weather request failed (${res.status})`);
      return res.json();
    }

    async function callModelFromWeatherUI() {
      // Read from UI
      const Temperature_C = parseFloat(el.temp.textContent);
      const Humidity_pct = parseFloat(el.humidity.textContent);
      const Wind_kmh = parseFloat(el.wind.textContent);
      const Rain_mm = parseFloat(el.rain.textContent);

      const DayOfWeek = el.day.textContent || dayShortFromDate(new Date());
      const SkyCondition = el.cond.textContent || el.desc.textContent || "Partly Cloudy";

      if (![Temperature_C, Humidity_pct, Wind_kmh, Rain_mm].every(Number.isFinite)) {
        el.apiStatus.textContent = "Status: cannot call model (weather not ready)";
        return;
      }

      const payload = { Temperature_C, DayOfWeek, SkyCondition, Humidity_pct, Wind_kmh, Rain_mm, top_k: 3 };

      el.apiStatus.textContent = "Status: calling model…";

      const res = await fetch(MODEL_API, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        el.apiStatus.textContent = `Status: model error (${res.status})`;
        console.error("Model error:", res.status, await res.text());
        return;
      }

      const data = await res.json();
      const cards = data.disease_cards || [];

      if (cards[0]) setCard(1, cards[0].disease, cards[0].confidence_pct, cards[0].comment);
      if (cards[1]) setCard(2, cards[1].disease, cards[1].confidence_pct, cards[1].comment);
      if (cards[2]) setCard(3, cards[2].disease, cards[2].confidence_pct, cards[2].comment);

      el.apiStatus.textContent = "Status: model updated cards ✅";
    }

    async function loadLagos() {
      el.city.textContent = CITY;
      el.note.textContent = "Fixed coordinates for demo (no GPS required).";
      el.apiStatus.textContent = "Status: fetching weather…";

      try {
        const data = await fetchWeather();
        const cur = data.current || {};

        const tempC = cur.temperature_2m;
        const rh = cur.relative_humidity_2m;
        const rainMm = cur.precipitation;       // mm
        const windMs = cur.wind_speed_10m;      // m/s
        const windKmh = (typeof windMs === "number") ? (windMs * 3.6) : null;

        el.temp.textContent = (tempC ?? "--");
        el.when.textContent = cur.time ? formatWhen(new Date(cur.time)) : "--";
        el.desc.textContent = weatherCodeToText(cur.weather_code);

        el.humidity.textContent = (rh ?? "--");
        el.wind.textContent = windKmh !== null ? windKmh.toFixed(0) : "--";
        el.rain.textContent = (rainMm ?? "--");

        const d = dayShortFromDate(new Date());
        el.day.textContent = d;
        el.cond.textContent = el.desc.textContent;

        el.apiStatus.textContent = "Status: weather ready ✅ calling model…";
        await callModelFromWeatherUI();

      } catch (e) {
        console.error(e);
        el.apiStatus.textContent = "Status: weather failed ❌";
        el.note.textContent = "Could not load weather. Check internet and press Refresh.";
        el.temp.textContent = "--";
      }
    }

    el.refresh?.addEventListener("click", loadLagos);
    window.addEventListener("DOMContentLoaded", loadLagos);
  </script>
</body>
</html>
