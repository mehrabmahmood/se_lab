<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Disease Risk Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body class="min-h-screen bg-slate-100 text-slate-800">
    <div class="mx-auto max-w-6xl p-4 sm:p-6">
      <!-- TOP WEATHER BAR -->
      <section
        class="relative overflow-hidden rounded-2xl bg-gradient-to-r from-emerald-950 via-emerald-900 to-emerald-800 p-5 text-white shadow-lg"
      >
        <div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
          <!-- Left: location + temp -->
          <div class="flex items-center gap-4">
            <!-- icon -->
            <div class="grid h-14 w-14 place-items-center rounded-full bg-emerald-900/50 ring-1 ring-white/10">
              <svg viewBox="0 0 64 64" class="h-10 w-10" fill="none" aria-hidden="true">
                <circle cx="32" cy="32" r="14" fill="#FBBF24" />
                <g stroke="#FCD34D" stroke-width="4" stroke-linecap="round">
                  <path d="M32 6v8" />
                  <path d="M32 50v8" />
                  <path d="M6 32h8" />
                  <path d="M50 32h8" />
                  <path d="M13 13l6 6" />
                  <path d="M45 45l6 6" />
                  <path d="M51 13l-6 6" />
                  <path d="M19 45l-6 6" />
                </g>
              </svg>
            </div>

            <div class="leading-tight">
              <div id="wxCity" class="text-lg font-semibold opacity-95">Loading location…</div>

              <div class="flex items-end gap-2">
                <div id="wxTemp" class="text-5xl font-bold tracking-tight">--</div>
                <div class="pb-1 text-2xl font-semibold opacity-90">°C</div>
              </div>

              <div class="mt-1 flex flex-wrap items-center gap-x-3 gap-y-1 text-sm text-white/80">
                <span id="wxWhen">--</span>
                <span class="hidden sm:inline">|</span>
                <span id="wxDesc">--</span>
                <span class="hidden sm:inline">|</span>
                <span>Humidity: <span id="wxHumidity">--</span>%</span>
                <span class="hidden sm:inline">|</span>
                <span>Wind: <span id="wxWind">--</span> km/h</span>
                <span class="hidden sm:inline">|</span>
                <span>Rain: <span id="wxRain">--</span> mm</span>
              </div>

              <div id="wxNote" class="mt-1 text-xs text-white/60"></div>
            </div>
          </div>

          <!-- Right: chart + tabs (kept as-is) -->
          <div class="w-full lg:max-w-[640px]">
            <div class="flex items-center gap-4">
              <div class="flex items-center gap-3 text-sm">
                <button class="relative font-semibold text-white">
                  Temperature
                  <span class="absolute -bottom-2 left-0 h-0.5 w-full rounded bg-amber-300"></span>
                </button>
                <button class="text-white/65 hover:text-white/85">Precipitation</button>
              </div>

              <button
                id="wxRefresh"
                class="ml-auto rounded-lg bg-white/10 px-3 py-2 text-xs font-semibold text-white/90 ring-1 ring-white/10 hover:bg-white/15"
                type="button"
                title="Refresh weather"
              >
                Refresh
              </button>
            </div>

            <!-- Static placeholder chart -->
            <div class="mt-4 rounded-xl bg-white/5 p-4 ring-1 ring-white/10">
              <div class="flex justify-between text-xs text-white/70">
                <span>5 PM</span><span>8 PM</span><span>11 AM</span><span>11 AM</span><span>1 AM</span><span>2 PM</span>
              </div>

              <div class="mt-2">
                <svg viewBox="0 0 600 120" class="h-20 w-full" aria-hidden="true">
                  <path d="M10 95 H590" stroke="rgba(255,255,255,0.12)" stroke-width="2" />
                  <path
                    d="M20 70
                       C 90 72, 110 85, 160 82
                       S 250 68, 300 74
                       S 390 92, 440 86
                       S 530 52, 580 44"
                    fill="none"
                    stroke="#FCD34D"
                    stroke-width="4"
                    stroke-linecap="round"
                  />
                  <g fill="#FCD34D">
                    <circle cx="20" cy="70" r="5" />
                    <circle cx="160" cy="82" r="5" />
                    <circle cx="300" cy="74" r="5" />
                    <circle cx="440" cy="86" r="5" />
                    <circle cx="580" cy="44" r="5" />
                  </g>
                  <g fill="rgba(255,255,255,0.9)" font-size="14" font-weight="700">
                    <text x="8" y="52">19</text>
                    <text x="150" y="64">16</text>
                    <text x="290" y="56">16</text>
                    <text x="430" y="68">12</text>
                    <text x="567" y="26">22</text>
                  </g>
                </svg>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- MAIN GRID -->
      <main class="mt-6 grid grid-cols-1 gap-6 lg:grid-cols-2">
        <!-- LEFT: PROBABLE DISEASE RISK -->
        <section class="rounded-2xl bg-white p-5 shadow-lg ring-1 ring-slate-200">
          <div class="flex items-center justify-between">
            <h2 class="text-xl font-semibold text-emerald-900">Probable Disease Risk</h2>
          </div>

          <div class="mt-4 overflow-hidden rounded-2xl ring-1 ring-slate-200">
            <div class="relative h-40 bg-[url('./image.webp')] bg-cover bg-center">
              <div class="absolute inset-0 bg-emerald-950/35"></div>
              <div class="absolute inset-0 bg-gradient-to-r from-emerald-950/40 via-emerald-950/10 to-transparent"></div>

              <!-- BIG CARD (dynamic) -->
              <div
                class="absolute left-4 top-4 flex items-start gap-4 rounded-xl bg-emerald-950/85 px-4 py-3 text-white shadow-xl ring-1 ring-white/10"
              >
                <div>
                  <div class="text-lg font-semibold">
                    <span id="risk1Name">Late Blight</span>
                    <span class="ml-2 inline-block h-0.5 w-14 rounded bg-amber-300 align-middle"></span>
                  </div>
                  <div id="risk1Note" class="mt-1 text-sm text-white/75">Wet conditions &amp; cool temps.</div>
                </div>

                <div id="risk1Score" class="ml-2 grid h-10 w-16 place-items-center rounded-lg bg-rose-600 text-sm font-bold shadow">
                  82%
                </div>
              </div>
            </div>
          </div>

          <div class="mt-4 grid grid-cols-1 gap-3 sm:grid-cols-3">
            <!-- SMALL CARD 1 (dynamic) -->
            <div class="rounded-xl bg-emerald-950 p-4 text-white shadow-sm ring-1 ring-emerald-900/40">
              <div class="flex items-start justify-between gap-2">
                <div class="font-semibold leading-tight">
                  <span id="risk2Name">Powdery Mildew</span>
                  <span
                    id="risk2Score"
                    class="ml-2 inline-flex rounded-md bg-amber-300/90 px-2 py-0.5 text-sm font-bold text-emerald-950"
                  >56%</span>
                </div>
              </div>
              <div id="risk2Note" class="mt-2 text-sm text-white/75">Humid weather</div>
            </div>

            <!-- SMALL CARD 2 (dynamic) -->
            <div class="rounded-xl bg-white p-4 shadow-sm ring-1 ring-slate-200">
              <div class="flex items-start justify-between gap-2">
                <div class="font-semibold leading-tight text-emerald-900">
                  <span id="risk3Name">Leaf Spot</span>
                  <span
                    id="risk3Score"
                    class="ml-2 inline-flex rounded-md bg-emerald-600 px-2 py-0.5 text-sm font-bold text-white"
                  >30%</span>
                </div>
              </div>
              <div id="risk3Note" class="mt-2 text-sm text-slate-500">Recent dry period</div>
            </div>

            <!-- Trend card (unchanged) -->
            <div class="rounded-xl bg-white p-4 shadow-sm ring-1 ring-slate-200">
              <div class="text-xs font-semibold text-slate-500">Trend</div>
              <svg viewBox="0 0 120 50" class="mt-2 h-10 w-full" aria-hidden="true">
                <path
                  d="M5 40 L25 32 L45 34 L65 26 L85 20 L105 12"
                  fill="none"
                  stroke="#F59E0B"
                  stroke-width="3"
                  stroke-linecap="round"
                />
                <g fill="#F59E0B">
                  <circle cx="5" cy="40" r="3" />
                  <circle cx="25" cy="32" r="3" />
                  <circle cx="45" cy="34" r="3" />
                  <circle cx="65" cy="26" r="3" />
                  <circle cx="85" cy="20" r="3" />
                  <circle cx="105" cy="12" r="3" />
                </g>
              </svg>
            </div>
          </div>
        </section>

        <!-- RIGHT: EXPLANATION & ACTIONS -->
        <section class="rounded-2xl bg-white p-5 shadow-lg ring-1 ring-slate-200">
          <h2 class="text-xl font-semibold text-emerald-900">Explanation &amp; Actions</h2>
          <p class="mt-4 text-sm text-slate-600">
            (We’ll connect this to the ML model later.)
          </p>
        </section>
      </main>
    </div>

    <!-- ✅ LIVE WEATHER + ✅ MODEL CALL -->
    <script>
      const MODEL_API = "http://127.0.0.1:8000/predict";
      const DEFAULT_COORDS = { lat: 23.8103, lon: 90.4125, label: "Dhaka (default)" };

      const el = {
        city: document.getElementById("wxCity"),
        temp: document.getElementById("wxTemp"),
        when: document.getElementById("wxWhen"),
        desc: document.getElementById("wxDesc"),
        humidity: document.getElementById("wxHumidity"),
        wind: document.getElementById("wxWind"),
        rain: document.getElementById("wxRain"),
        note: document.getElementById("wxNote"),
        refresh: document.getElementById("wxRefresh"),
      };

      function weatherCodeToText(code) {
        const map = [
          { codes: [0], text: "Clear" },
          { codes: [1, 2], text: "Partly cloudy" },
          { codes: [3], text: "Overcast" },
          { codes: [45, 48], text: "Fog" },
          { codes: [51, 53, 55, 56, 57], text: "Drizzle" },
          { codes: [61, 63, 65, 66, 67], text: "Rain" },
          { codes: [71, 73, 75, 77], text: "Snow" },
          { codes: [80, 81, 82], text: "Showers" },
          { codes: [95, 96, 99], text: "Thunderstorm" },
        ];
        for (const m of map) if (m.codes.includes(code)) return m.text;
        return "Weather";
      }

      function formatWhen(dateObj) {
        const day = dateObj.toLocaleDateString(undefined, { weekday: "long" });
        const time = dateObj.toLocaleTimeString(undefined, { hour: "numeric", minute: "2-digit" });
        return `${day} · ${time}`;
      }

      function dayShortFromDate(d) {
        const map = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
        return map[d.getDay()];
      }

      function setLoading(note) {
        el.city.textContent = "Getting weather…";
        el.temp.textContent = "--";
        el.when.textContent = "--";
        el.desc.textContent = "--";
        el.humidity.textContent = "--";
        el.wind.textContent = "--";
        el.rain.textContent = "--";
        el.note.textContent = note || "";
      }

      async function fetchWeather(lat, lon) {
        const url =
          "https://api.open-meteo.com/v1/forecast" +
          `?latitude=${encodeURIComponent(lat)}` +
          `&longitude=${encodeURIComponent(lon)}` +
          "&current=temperature_2m,relative_humidity_2m,precipitation,wind_speed_10m,weather_code" +
          "&timezone=auto";

        const res = await fetch(url);
        if (!res.ok) throw new Error(`Weather request failed (${res.status})`);
        return res.json();
      }

      function getGpsCoords() {
        return new Promise((resolve, reject) => {
          if (!navigator.geolocation) return reject(new Error("Geolocation not supported"));
          navigator.geolocation.getCurrentPosition(
            (pos) => resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude, label: "Near you" }),
            (err) => reject(err),
            { enableHighAccuracy: true, timeout: 8000 }
          );
        });
      }

      function setCard(n, disease, confPct, comment) {
        const setText = (id, v) => { const e = document.getElementById(id); if (e) e.textContent = v; };
        setText(`risk${n}Name`, disease);
        setText(`risk${n}Score`, `${confPct}%`);
        setText(`risk${n}Note`, comment);
      }

      async function callModelFromCurrentWeather() {
        // Read weather already shown in UI
        const Temperature_C = parseFloat(el.temp.textContent);
        const Humidity_pct = parseFloat(el.humidity.textContent);
        const Wind_kmh = parseFloat(el.wind.textContent);
        const Rain_mm = parseFloat(el.rain.textContent);

        // Use current time (or weather timestamp if available)
        const DayOfWeek = dayShortFromDate(new Date());
        const SkyCondition = el.desc.textContent || "Partly Cloudy";

        // Basic guard
        if (!Number.isFinite(Temperature_C) || !Number.isFinite(Humidity_pct) || !Number.isFinite(Wind_kmh) || !Number.isFinite(Rain_mm)) {
          return;
        }

        const payload = { Temperature_C, DayOfWeek, SkyCondition, Humidity_pct, Wind_kmh, Rain_mm, top_k: 3 };

        const res = await fetch(MODEL_API, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          console.error("Model error:", res.status, await res.text());
          return;
        }

        const data = await res.json();
        const cards = data.disease_cards || [];

        // Fill 3 cards if present
        if (cards[0]) setCard(1, cards[0].disease, cards[0].confidence_pct, cards[0].comment);
        if (cards[1]) setCard(2, cards[1].disease, cards[1].confidence_pct, cards[1].comment);
        if (cards[2]) setCard(3, cards[2].disease, cards[2].confidence_pct, cards[2].comment);
      }

      async function loadLiveWeather() {
        setLoading("Requesting GPS permission…");

        let coords = DEFAULT_COORDS;
        try {
          coords = await getGpsCoords();
          el.note.textContent = "Using device GPS.";
        } catch (e) {
          el.note.textContent = "GPS denied/unavailable — showing default (Dhaka).";
        }

        try {
          setLoading("Fetching live weather…");
          const data = await fetchWeather(coords.lat, coords.lon);
          const cur = data.current || {};

          const tempC = cur.temperature_2m;
          const rh = cur.relative_humidity_2m;
          const rainMm = cur.precipitation;       // mm
          const windMs = cur.wind_speed_10m;      // m/s
          const windKmh = (typeof windMs === "number") ? (windMs * 3.6) : null;

          el.city.textContent = coords.label;
          el.temp.textContent = (tempC ?? "--");
          el.when.textContent = cur.time ? formatWhen(new Date(cur.time)) : "--";
          el.desc.textContent = weatherCodeToText(cur.weather_code);
          el.humidity.textContent = (rh ?? "--");
          el.wind.textContent = windKmh !== null ? windKmh.toFixed(0) : "--";
          el.rain.textContent = (rainMm ?? "--");

          el.note.textContent = `${coords.label} • ${data.timezone || ""}`.trim();

          // ✅ after weather loads, call model and update the 3 cards
          await callModelFromCurrentWeather();

        } catch (e) {
          console.error(e);
          el.note.textContent = "Could not load weather. Check internet and press Refresh.";
          el.city.textContent = "Weather unavailable";
        }
      }

      el.refresh?.addEventListener("click", loadLiveWeather);
      window.addEventListener("DOMContentLoaded", loadLiveWeather);

      // Optional: auto-refresh every 30 minutes
      setInterval(loadLiveWeather, 30 * 60 * 1000);
    </script>
  </body>
</html>
